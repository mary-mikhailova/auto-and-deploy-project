# Автоматизация и деплой

## Описание
С ТЗ можно ознакомиться в файле [Описание.md](https://github.com/mary-mikhailova/auto-and-deploy-project/blob/main/%D0%9E%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5.md)

## Комментарии к генерации

С помощью скрипта generate_data.py генерируются чеки в формате *.csv, имитируя выгрузку чеков из N кассовых аппаратов сети магазинов в папку data/.

Геренация релизована по следующим принципам:
- Количество магазинов, касс, чеков, позиций, количество единиц в чеке генерируется в заданных пределах
- Время пробития чека в предлах текущего дня. Если оказывается, что в чеке несколько позиций (строк), каждая следующая позиция в рамках одного чека пробивается с интервалом в 2 секунды
- Стоимость продукта генерируется в пределах цен, установленных для категории, которой он пренадлежит
- Скидка генерируется с предположением, что она не может быть больше 30% от стоимости единицы товара

Пример сгенерированного csv-файла из директории data/:

  <img width="1375" height="290" alt="image" src="https://github.com/user-attachments/assets/5f1b3551-d840-4658-be10-88980309c586" />

## Подключение к БД PostgreSQL

Подключение к БД настроено через класс PGDatabase в файле pgdb.py. Занесение данных в БД осуществляется через функцию post.

## Загрузка в БД

Выгружаются файлы .csv из директории data/ с названием "цифры_цифры". Другие форматы файлов игнорируются. Примеры файлов можно посмотреть в папке [data](https://github.com/mary-mikhailova/auto-and-deploy-project/tree/main/data)

#  Запуск проекта на новой машине

- Склонировать репозиторий:

`git clone https://github.com/mary-mikhailova/auto-and-deploy-project.git`

- В файле config.ini указать необходимые настройки для БД:

[Database]

HOST = localhost     ; адрес сервера БД

PORT = 5432          ; порт сервера БД

DATABASE = postgres  ; имя БД

USER = postgres      ; пользователь БД

PASSWORD = #######   ; пароль пользователя БД


- Создать таблицу sales_shop_cash в БД:
<img width="1071" height="483" alt="image" src="https://github.com/user-attachments/assets/afe492f3-bde6-405b-86cc-087531f630cb" />



SQL-код для создания таблицы и констрейнов лежит в папке [sql](https://github.com/mary-mikhailova/auto-and-deploy-project/tree/main/sql)

## Дальнейшие инструкции выполнять из директории, где находятся все файлы репозитороия

- Создать виртуальное окружение:
  
`
python -m venv venv
`

- И активировать его:

`
./venv/Scripts/activate
`

- Установить необходимые пакеты из файла requirements.txt

`
pip install -r requirements.txt
`

- Создать две задачи в crontab, указав полные пути. Необходимо, чтобы сначала выполнялся файл generate, а потом load_to_bd. Crontab можно открыть введя команду:

`
crontab -e
`

Например, запускаем генерацию файлов по прадажам. Каждый в 23:59 кроме воскресенья, предполагая что в этот момент закрывается смена

59 23 * * 1-6 /home/auto-and-deploy-project/venv/bin/python /home/auto-and-deploy-project/generate.py

Загружаем данные по продажам в БД на сервере. Каждый день в 00:01 кроме понедельника (тк данные за воскресенье генерироваться не будут), преполагая что к этому моменту данные со всех магазинов будут получены

1 0 * * 2-7 /home/auto-and-deploy-project/venv/bin/python /home/auto-and-deploy-project/load_to_bd.py
